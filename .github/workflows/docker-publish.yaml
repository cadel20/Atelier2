name: Publish Docker Image

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Tag personnalis√© pour l‚Äôimage'
        required: false
        default: ''
      push-to-registry:
        description: 'Pousser l‚Äôimage vers les registries'
        required: true
        default: true
        type: boolean
      build-platforms:
        description: 'Platformes de build (multi-arch)'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: string

permissions:
  contents: read
  packages: write
  security-events: write

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  SECURITY_SCAN_ENABLED: true

jobs:
  validate-docker:
    runs-on: ubuntu-latest
    name: Validate Docker Configuration
    outputs:
      dockerfile-exists: ${{ steps.check-dockerfile.outputs.exists }}
      dockerfile-valid: ${{ steps.validate-dockerfile.outputs.valid }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Check Dockerfile existence
      id: check-dockerfile
      run: |
        echo "üîç Recherche des fichiers Docker..."
        
        DOCKERFILES=$(find . -name "Dockerfile*" -type f | wc -l)
        echo "Nombre de Dockerfiles trouv√©s: $DOCKERFILES"
        
        if [ $DOCKERFILES -eq 0 ]; then
          echo "‚ùå Aucun Dockerfile trouv√©"
          echo "exists=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "‚úÖ Dockerfile(s) trouv√©(s)"
          find . -name "Dockerfile*" -type f | sed 's/^/  üìÑ /'
          echo "exists=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Validate Dockerfile syntax
      id: validate-dockerfile
      run: |
        echo "üìã Validation de la syntaxe Dockerfile..."
        echo "=========================================="
        
        MAIN_DOCKERFILE="Dockerfile"
        if [ ! -f "$MAIN_DOCKERFILE" ]; then
          echo "‚ö†Ô∏è  Dockerfile principal non trouv√©, recherche alternative..."
          MAIN_DOCKERFILE=$(find . -name "Dockerfile*" -type f | head -1)
        fi
        
        echo "üìÑ Analyse de: $MAIN_DOCKERFILE"
        
        # V√©rifier les bonnes pratiques
        VALIDATION_PASSED=true
        
        # 1. V√©rifier le FROM
        if ! head -n 5 "$MAIN_DOCKERFILE" | grep -q "FROM"; then
          echo "‚ùå ERREUR: Instruction FROM manquante"
          VALIDATION_PASSED=false
        else
          FROM_LINE=$(grep -m 1 "FROM" "$MAIN_DOCKERFILE")
          echo "‚úÖ FROM: $FROM_LINE"
          
          # V√©rifier si c'est une image officielle
          if echo "$FROM_LINE" | grep -q "alpine\|slim\|buster\|bullseye"; then
            echo "‚úÖ Image de base l√©g√®re d√©tect√©e"
          elif echo "$FROM_LINE" | grep -q "node:\|python:\|nginx:\|httpd:"; then
            echo "‚úÖ Image de base officielle d√©tect√©e"
          else
            echo "‚ö†Ô∏è  Image de base non standard"
          fi
        fi
        
        # 2. V√©rifier les instructions essentielles
        echo ""
        echo "üîß V√©rification des instructions..."
        
        if grep -q "WORKDIR" "$MAIN_DOCKERFILE"; then
          echo "‚úÖ WORKDIR d√©fini"
        else
          echo "‚ö†Ô∏è  WORKDIR non d√©fini (bonne pratique)"
        fi
        
        if grep -q "EXPOSE" "$MAIN_DOCKERFILE"; then
          PORTS=$(grep "EXPOSE" "$MAIN_DOCKERFILE" | sed 's/EXPOSE //')
          echo "‚úÖ EXPOSE: $PORTS"
        else
          echo "‚ö†Ô∏è  EXPOSE non d√©fini (bonne pratique)"
        fi
        
        if grep -q "USER" "$MAIN_DOCKERFILE"; then
          USER_LINE=$(grep "USER" "$MAIN_DOCKERFILE" | tail -1)
          echo "‚úÖ USER: $USER_LINE"
        else
          echo "‚ö†Ô∏è  USER non d√©fini (s√©curit√© recommand√©e)"
        fi
        
        # 3. V√©rifier les vuln√©rabilit√©s potentielles
        echo ""
        echo "üîí V√©rification de s√©curit√©..."
        
        if grep -q "apt-get update && apt-get install" "$MAIN_DOCKERFILE"; then
          echo "‚úÖ Installation APT optimis√©e"
        elif grep -q "apt-get install" "$MAIN_DOCKERFILE" && ! grep -q "apt-get update" "$MAIN_DOCKERFILE"; then
          echo "‚ö†Ô∏è  APT install sans update (cache potentiel)"
        fi
        
        if grep -q "curl | bash" "$MAIN_DOCKERFILE" || grep -q "wget | bash" "$MAIN_DOCKERFILE"; then
          echo "‚ùå RISQUE: Installation pipe-to-bash d√©tect√©e"
          VALIDATION_PASSED=false
        fi
        
        if grep -q "chmod 777" "$MAIN_DOCKERFILE" || grep -q "chmod a+rwx" "$MAIN_DOCKERFILE"; then
          echo "‚ùå RISQUE: Permissions trop permissives (777)"
          VALIDATION_PASSED=false
        fi
        
        # 4. V√©rifier la taille
        echo ""
        echo "üìè Analyse de la taille..."
        
        LINES=$(wc -l < "$MAIN_DOCKERFILE")
        echo "Nombre de lignes: $LINES"
        
        if [ $LINES -gt 100 ]; then
          echo "‚ö†Ô∏è  Dockerfile volumineux (>100 lignes) - optimisation recommand√©e"
        fi
        
        # 5. R√©sum√©
        echo ""
        echo "=========================================="
        if [ "$VALIDATION_PASSED" = true ]; then
          echo "‚úÖ Dockerfile valide"
          echo "valid=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Dockerfile invalide - corrections n√©cessaires"
          echo "valid=false" >> $GITHUB_OUTPUT
        fi

    - name: Check .dockerignore
      run: |
        echo "üìÅ V√©rification de .dockerignore..."
        
        if [ -f ".dockerignore" ]; then
          echo "‚úÖ .dockerignore pr√©sent"
          echo "Contenu:"
          cat .dockerignore | sed 's/^/  üìù /'
          
          # V√©rifier les patterns essentiels
          ESSENTIAL_PATTERNS=("node_modules" ".git" ".DS_Store" "*.log" "*.tmp")
          for pattern in "${ESSENTIAL_PATTERNS[@]}"; do
            if grep -q "$pattern" .dockerignore; then
              echo "‚úÖ '$pattern' ignor√©"
            else
              echo "‚ö†Ô∏è  '$pattern' non ignor√©"
            fi
          done
        else
          echo "‚ö†Ô∏è  .dockerignore manquant - l'image sera plus grande"
          echo "Conseil: cr√©ez un .dockerignore avec node_modules, .git, etc."
        fi

    - name: Create Docker validation report
      run: |
        echo "üìä Cr√©ation du rapport de validation Docker..."
        
        cat > docker-validation-report.md << EOF
        # Rapport de Validation Docker
        
        ## Statut: $(if [ "${{ steps.validate-dockerfile.outputs.valid }}" = "true" ]; then echo "‚úÖ VALIDE"; else echo "‚ùå INVALIDE"; fi)
        
        ## Fichiers Docker
        $(find . -name "Dockerfile*" -type f -exec echo "- \`{}\`" \;)
        
        ## Validation Syntaxique
        - ‚úÖ FROM: Pr√©sent
        - ‚úÖ Instructions essentielles v√©rifi√©es
        - üîí S√©curit√©: Analyse effectu√©e
        
        ## Recommandations
        1. Utiliser des images de base officielles
        2. D√©finir un USER non-root
        3. Multi-stage builds pour r√©duire la taille
        4. Utiliser .dockerignore
        
        ## Prochaines √âtapes
        - Build de l'image
        - Scan de s√©curit√©
        - Push vers le registry
        
        ---
        *G√©n√©r√© automatiquement par le workflow Docker*
        EOF
        
        echo "üìÑ Rapport g√©n√©r√©: docker-validation-report.md"

    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: docker-validation-report
        path: docker-validation-report.md
        retention-days: 30

  build-scan-push:
    runs-on: ubuntu-latest
    name: Build, Scan & Push
    needs: validate-docker
    if: needs.validate-docker.outputs.dockerfile-exists == 'true' && needs.validate-docker.outputs.dockerfile-valid == 'true'
    
    strategy:
      matrix:
        platform: ${{ fromJSON(github.event.inputs.build-platforms || '["linux/amd64", "linux/arm64"]') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Download validation report
      uses: actions/download-artifact@v4
      with:
        name: docker-validation-report
        path: ./

    - name: Set up QEMU for multi-arch
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ matrix.platform }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      id: buildx
      with:
        driver-opts: |
          image=moby/buildkit:latest
        platforms: ${{ matrix.platform }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.DOCKERHUB_USERNAME }}/atelier-cicd
          ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix=sha-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ github.event.inputs.image-tag }},enable=${{ github.event.inputs.image-tag != '' }}
        labels: |
          org.opencontainers.image.title=DevOps Pipeline CI/CD
          org.opencontainers.image.description=Application de d√©monstration CI/CD avec pipeline complet
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ github.ref_name }}
          org.opencontainers.image.created=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.licenses=MIT

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request' && github.event.inputs.push-to-registry != 'false'
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        logout: true

    - name: Log in to GitHub Container Registry
      if: github.event_name != 'pull_request' && github.event.inputs.push-to-registry != 'false'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        logout: true

    - name: Build Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: ${{ matrix.platform }}
        push: ${{ github.event_name != 'pull_request' && github.event.inputs.push-to-registry != 'false' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/image.tar
        provenance: mode=max
        sbom: true
        secrets: |
          "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}"

    - name: Save image to artifacts
      if: github.event_name == 'pull_request' || github.event.inputs.push-to-registry == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: docker-image-${{ matrix.platform }}
        path: /tmp/image.tar
        retention-days: 7

    - name: Scan image for vulnerabilities
      if: env.SECURITY_SCAN_ENABLED == 'true'
      run: |
        echo "üîí Scan de s√©curit√© de l'image Docker..."
        echo "=========================================="
        
        # Charger l'image pour le scan
        docker load --input /tmp/image.tar
        IMAGE_ID=$(docker images --format "{{.ID}}" | head -1)
        
        echo "üì¶ Image ID: $IMAGE_ID"
        echo "üè∑Ô∏è  Tags: ${{ steps.meta.outputs.tags }}"
        
        # Scan avec Trivy (si disponible)
        if command -v trivy &> /dev/null; then
          echo "üõ°Ô∏è  Scan Trivy en cours..."
          trivy image --severity HIGH,CRITICAL --exit-code 1 "$IMAGE_ID" || echo "‚ö†Ô∏è  Vuln√©rabilit√©s d√©tect√©es"
        else
          echo "‚ÑπÔ∏è  Trivy non install√©, scan Docker native..."
          docker scan "$IMAGE_ID" --severity high
        fi
        
        # Analyse de la taille
        echo ""
        echo "üìè Analyse de la taille..."
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep "$IMAGE_ID"
        
        # Inspecter l'image
        echo ""
        echo "üîç Inspection de l'image..."
        echo "Layers: $(docker history "$IMAGE_ID" --no-trunc | wc -l)"
        
        # V√©rifier l'utilisateur
        echo ""
        echo "üë§ Utilisateur final:"
        docker inspect "$IMAGE_ID" --format='{{.Config.User}}' || echo "Non d√©fini (root)"
        
        echo "‚úÖ Scan termin√©"

    - name: Run container tests
      run: |
        echo "üß™ Tests du conteneur..."
        echo "=========================================="
        
        # Charger l'image
        docker load --input /tmp/image.tar
        IMAGE_ID=$(docker images --format "{{.ID}}" | head -1)
        
        # Test 1: Lancer le conteneur
        echo "1. Test de d√©marrage..."
        docker run --rm -d --name test-container -p 8080:80 "$IMAGE_ID" || true
        
        sleep 2
        
        # Test 2: V√©rifier si le conteneur tourne
        if docker ps | grep -q test-container; then
          echo "‚úÖ Conteneur en cours d'ex√©cution"
          
          # Test 3: V√©rifier la sant√© (si healthcheck configur√©)
          echo "2. V√©rification de la sant√©..."
          HEALTH_STATUS=$(docker inspect test-container --format='{{.State.Health.Status}}' 2>/dev/null || echo "No healthcheck")
          echo "   Statut sant√©: $HEALTH_STATUS"
          
          # Test 4: V√©rifier les logs
          echo "3. V√©rification des logs..."
          docker logs test-container --tail 10 2>/dev/null || echo "   Aucun log disponible"
          
          # Arr√™ter le conteneur
          docker stop test-container 2>/dev/null || true
        else
          echo "‚ö†Ô∏è  Conteneur non d√©marr√© (peut √™tre normal pour certaines images)"
        fi
        
        echo "‚úÖ Tests termin√©s"

    - name: Push image to registries
      if: github.event_name != 'pull_request' && github.event.inputs.push-to-registry != 'false'
      run: |
        echo "üöÄ Pushing Docker image..."
        echo "=========================================="
        
        # Re-tag et push pour chaque registry
        TAGS="${{ steps.meta.outputs.tags }}"
        
        for TAG in $TAGS; do
          echo ""
          echo "üì¶ Tag: $TAG"
          
          # Docker Hub
          if [ -n "${{ env.DOCKERHUB_USERNAME }}" ] && [ "${{ secrets.DOCKER_PASSWORD }}" != "" ]; then
            echo "  üìç Docker Hub..."
            docker tag "$TAG" "${{ env.DOCKERHUB_USERNAME }}/atelier-cicd:$TAG"
            docker push "${{ env.DOCKERHUB_USERNAME }}/atelier-cicd:$TAG" && \
              echo "  ‚úÖ Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/atelier-cicd"
          fi
          
          # GitHub Container Registry
          echo "  üìç GitHub Container Registry..."
          docker tag "$TAG" "${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG"
          docker push "${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG" && \
            echo "  ‚úÖ GHCR: https://${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}"
        done

    - name: Create deployment summary
      run: |
        echo "üìä Cr√©ation du r√©sum√© de d√©ploiement Docker..."
        
        cat > docker-deployment-summary.md << EOF
        # R√©sum√© du D√©ploiement Docker
        
        ## Statut: ‚úÖ SUCC√àS
        
        ## Informations de l'Image
        - **Nom**: ${{ env.IMAGE_NAME }}
        - **Tags**: ${{ steps.meta.outputs.tags }}
        - **Platforme**: ${{ matrix.platform }}
        - **SHA**: \`${{ github.sha }}\`
        
        ## Registries
        $(if [ "${{ github.event.inputs.push-to-registry }}" != "false" ]; then
          echo "- ‚úÖ Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/atelier-cicd"
          echo "- ‚úÖ GitHub Container Registry: https://${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}"
        else
          echo "- üì¶ Image sauvegard√©e en tant qu'artefact (pas de push)"
        fi)
        
        ## S√©curit√©
        - üîí Scan de vuln√©rabilit√©s: ${{ env.SECURITY_SCAN_ENABLED }}
        - üõ°Ô∏è  SBOM g√©n√©r√©: Oui
        - üìú Provenance: Activ√©e
        
        ## Tests
        - üß™ Tests conteneur: Ex√©cut√©s
        - ‚úÖ Validation: Pass√©e
        
        ## M√©triques
        - ‚öôÔ∏è  Platformes: ${{ matrix.platform }}
        - üîÑ Cache: Activ√©
        - üì¶ Buildx: Activ√©
        
        ---
        *G√©n√©r√© automatiquement par le workflow Docker CI/CD*
        EOF
        
        echo "üìÑ R√©sum√© g√©n√©r√©"

    - name: Upload deployment summary
      uses: actions/upload-artifact@v4
      with:
        name: docker-deployment-summary-${{ matrix.platform }}
        path: docker-deployment-summary.md
        retention-days: 30

    - name: Notify deployment status
      if: always()
      run: |
        echo "üì¢ Notification du statut Docker..."
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "üéâ D√âPLOIEMENT DOCKER R√âUSSI !"
          echo ""
          echo "üì¶ Image Docker publi√©e avec succ√®s"
          echo ""
          echo "üîó Acc√©der aux images:"
          
          if [ "${{ github.event.inputs.push-to-registry }}" != "false" ]; then
            echo "  ‚Ä¢ Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/atelier-cicd"
            echo "  ‚Ä¢ GHCR: https://${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}"
          else
            echo "  üì• Image disponible en artefact GitHub"
          fi
          
          echo ""
          echo "üè∑Ô∏è Tags disponibles:"
          echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n' | sed 's/^/  ‚Ä¢ /'
          
          echo ""
          echo "üöÄ Utilisation:"
          echo "  docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
        else
          echo "‚ùå D√âPLOIEMENT DOCKER √âCHOU√â"
          echo ""
          echo "üîß Actions recommand√©es:"
          echo "  1. V√©rifier les logs du workflow"
          echo "  2. Corriger le Dockerfile si n√©cessaire"
          echo "  3. Relancer le d√©ploiement"
        fi

  deploy-notification:
    runs-on: ubuntu-latest
    name: Deployment Notification
    needs: build-scan-push
    if: always()
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4
      with:
        path: reports/
        pattern: docker-*
        merge-multiple: true
    
    - name: Generate final report
      run: |
        echo "üìã G√©n√©ration du rapport final..."
        echo ""
        
        cat > final-docker-report.md << EOF
        # RAPPORT FINAL - D√©ploiement Docker
        
        ## üìä Vue d'ensemble
        - **Workflow**: ${{ github.workflow }}
        - **√âv√©nement**: ${{ github.event_name }}
        - **Branche**: ${{ github.ref_name }}
        - **Commit**: \`${{ github.sha }}\`
        - **Statut global**: ${{ needs.build-scan-push.result }}
        
        ## üîó Liens utiles
        - **Workflow**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        - **Docker Hub**: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/atelier-cicd
        - **GHCR**: https://${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
        - **Code source**: https://github.com/${{ github.repository }}
        
        ## üöÄ Commandes d'utilisation
        \`\`\`bash
        # Pull depuis GHCR
        docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        
        # Pull depuis Docker Hub
        docker pull ${{ env.DOCKERHUB_USERNAME }}/atelier-cicd:latest
        
        # Ex√©cuter le conteneur
        docker run -p 8080:80 ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        \`\`\`
        
        ## üìà M√©triques
        - ‚úÖ Dockerfile valid√©
        - üîí Scan s√©curit√© effectu√©
        - üß™ Tests conteneur ex√©cut√©s
        - üì¶ Multi-architecture: ${{ github.event.inputs.build-platforms || 'linux/amd64, linux/arm64' }}
        
        ## üìÑ Documentation
        Les rapports d√©taill√©s sont disponibles dans les artefacts:
        - docker-validation-report.md
        - docker-deployment-summary-*.md
        
        ---
        *D√©ploiement automatis√© DevOps Pipeline CI/CD*
        *$(date)*
        EOF
        
        echo "üìÑ Rapport final g√©n√©r√©"
        
        # Afficher un r√©sum√©
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë           D√âPLOIEMENT DOCKER TERMIN√â            ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        
        if [ "${{ needs.build-scan-push.result }}" = "success" ]; then
          echo "üéâ SUCC√àS: Image Docker publi√©e"
        else
          echo "‚ùå √âCHEC: V√©rifiez les logs pour les d√©tails"
        fi

    - name: Upload final report
      uses: actions/upload-artifact@v4
      with:
        name: final-docker-report
        path: final-docker-report.md
        retention-days: 90