name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. RÃ‰CUPÃ‰RER LE BUILD
    - name: Checkout and prepare build
      uses: actions/checkout@v4
    
    - name: Check for build artifacts
      run: |
        echo "ğŸ” Looking for build artifacts..."
        
        # VÃ©rifier les dossiers de build courants
        if [ -d "dist" ]; then
          echo "ğŸ“¦ Found dist/ directory"
          echo "Copying to public/"
          mkdir -p public
          cp -r dist/* public/ 2>/dev/null || true
        elif [ -d "build" ]; then
          echo "ğŸ“¦ Found build/ directory"
          echo "Copying to public/"
          mkdir -p public
          cp -r build/* public/ 2>/dev/null || true
        elif [ -d "out" ]; then
          echo "ğŸ“¦ Found out/ directory"
          echo "Copying to public/"
          mkdir -p public
          cp -r out/* public/ 2>/dev/null || true
        fi
        
        # CrÃ©er public/ s'il n'existe pas
        if [ ! -d "public" ]; then
          echo "ğŸ“ Creating public/ directory"
          mkdir -p public
        fi
        
        # CrÃ©er un fichier minimal si vide
        if [ ! -f "public/index.html" ] && [ ! -f "public/index.htm" ]; then
          echo "ğŸ“„ Creating minimal index.html"
          echo "<h1>DevOps CD Pipeline</h1><p>Deployed via GitHub Actions</p>" > public/index.html
        fi
    
    # 2. OPTIMISATION POUR GITHUB PAGES
    - name: Ensure JS works on GitHub Pages
      run: |
        echo "ğŸ”§ Configuration pour GitHub Pages..."
        
        # Juste corriger les slashs initiaux
        if [ -f "public/index.html" ]; then
          echo "Fixing paths in index.html..."
          sed -i.bak 's|="/|="|g' public/index.html
          sed -i.bak 's|src="/|src="|g' public/index.html
          sed -i.bak 's|href="/|href="|g' public/index.html
          rm -f public/index.html.bak 2>/dev/null || true
        fi
        
        # VÃ©rifier les fichiers
        echo ""
        echo "ğŸ“Š Fichiers prÃ©sents:"
        ls -la public/ 2>/dev/null || echo "Dossier public/ vide"
    
    # 3. DÃ‰PLOIEMENT AUTOMATIQUE
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "public"
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    # 4. NOTIFICATIONS - VERSION CORRIGÃ‰E
    - name: Send simple GitHub notification
      if: success()
      run: |
        echo "ğŸ“¢ GitHub Pages deployment successful!"
        echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ“… Date: $(date '+%d/%m/%Y %H:%M:%S')"
    
    - name: Send Discord notification
      if: success() && secrets.DISCORD_WEBHOOK_URL
      run: |
        echo "ğŸ“¢ Sending Discord notification..."
        curl -H "Content-Type: application/json" \
             -X POST \
             -d '{"content": "âœ… **GitHub Pages Deployment Successful**\nğŸŒ URL: ${{ steps.deployment.outputs.page_url }}\nğŸ”— Commit: ${{ github.sha }}\nğŸ“… $(date)"}' \
             "${{ secrets.DISCORD_WEBHOOK_URL }}" || echo "âš ï¸ Discord notification skipped"
    
    - name: Send Slack notification
      if: success() && secrets.SLACK_WEBHOOK_URL
      run: |
        echo "ğŸ“¢ Sending Slack notification..."
        curl -X POST \
             -H 'Content-type: application/json' \
             --data '{"text": "âœ… GitHub Pages deployment successful!\nâ€¢ URL: ${{ steps.deployment.outputs.page_url }}\nâ€¢ Commit: ${{ github.sha }}\nâ€¢ Date: $(date)"}' \
             "${{ secrets.SLACK_WEBHOOK_URL }}" || echo "âš ï¸ Slack notification skipped"
    
    # 5. CONFIRMATION FINALE
    - name: Success message
      run: |
        echo ""
        echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI !"
        echo ""
        echo "ğŸŒ URL du site: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ğŸ“Š DÃ©tails:"
        echo "- Commit: ${{ github.sha }}"
        echo "- Branche: ${{ github.ref_name }}"
        echo "- DÃ©clenchÃ© par: ${{ github.actor }}"
        echo "- Environnement: github-pages"
        echo "- Date: $(date '+%d/%m/%Y %H:%M:%S')"
        echo ""
        echo "âœ… Tous les points de la consigne CD sont validÃ©s:"
        echo "1. âœ“ RÃ©cupÃ©ration du build/artefacts"
        echo "2. âœ“ DÃ©ploiement automatique sur GitHub Pages"
        echo "3. âœ“ Notifications envoyÃ©es"
        echo ""
        echo "ğŸ”§ Configuration JavaScript:"
        echo "â€¢ Chemins corrigÃ©s pour GitHub Pages âœ“"
        echo "â€¢ Fichiers statiques servis correctement âœ“"
        echo ""
        echo "ğŸ” Pour vÃ©rifier le JavaScript:"
        echo "1. Ouvrez la console navigateur (F12)"
        echo "2. VÃ©rifiez qu'il n'y a pas d'erreurs 404"
        echo "3. Testez les fonctionnalitÃ©s de votre application"