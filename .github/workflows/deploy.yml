name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de d√©ploiement'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force-deploy:
        description: 'Forcer le d√©ploiement m√™me si des tests √©chouent'
        required: false
        default: false
        type: boolean

permissions:
  pages: write
  id-token: write
  contents: read

env:
  NODE_ENV: production
  DEPLOY_ENV: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'production' }}
  SOURCE_DIR: public  # Dossier source pour le d√©ploiement

jobs:
  validate-deployment:
    runs-on: ubuntu-latest
    name: Validate Deployment
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Validate public directory
      run: |
        echo "üîç Validation du dossier public..."
        echo "=========================================="
        
        # V√©rifier l'existence du dossier public
        if [ ! -d "${{ env.SOURCE_DIR }}" ]; then
          echo "‚ùå ERREUR: Dossier '${{ env.SOURCE_DIR }}' manquant"
          echo "Votre structure de projet doit inclure un dossier '${{ env.SOURCE_DIR }}/' contenant index.html"
          exit 1
        fi
        
        echo "‚úÖ Dossier '${{ env.SOURCE_DIR }}/' pr√©sent"
        
        # V√©rifier les fichiers obligatoires dans public/
        REQUIRED_FILES=("index.html")
        missing_files=0
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "${{ env.SOURCE_DIR }}/$file" ]; then
            echo "‚ùå ERREUR: $file manquant dans ${{ env.SOURCE_DIR }}/ - requis pour le d√©ploiement"
            missing_files=$((missing_files + 1))
          else
            echo "‚úÖ ${{ env.SOURCE_DIR }}/$file pr√©sent"
          fi
        done
        
        if [ $missing_files -gt 0 ]; then
          echo ""
          echo "‚ùå $missing_files fichier(s) manquant(s) - d√©ploiement impossible"
          exit 1
        fi
        
        # V√©rifier la structure du dossier public
        echo ""
        echo "üìÅ Structure du dossier ${{ env.SOURCE_DIR }}:"
        find "${{ env.SOURCE_DIR }}" -type f | head -20 | sed 's/^/  üìÑ /'
        
        TOTAL_FILES=$(find "${{ env.SOURCE_DIR }}" -type f | wc -l)
        echo "Total fichiers: $TOTAL_FILES"
        
        if [ $TOTAL_FILES -eq 0 ]; then
          echo "‚ö†Ô∏è  ATTENTION: Dossier ${{ env.SOURCE_DIR }} vide"
        fi

    - name: Validate deployment files
      run: |
        echo "üîç Validation des fichiers de d√©ploiement..."
        echo "=========================================="
        
        # V√©rifier la taille totale
        echo "üìè Analyse de la taille du projet..."
        TOTAL_SIZE=$(find "${{ env.SOURCE_DIR }}" -type f -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" 2>/dev/null | xargs stat -f%z 2>/dev/null | awk '{sum+=$1} END {print sum}')
        
        if [ -z "$TOTAL_SIZE" ]; then
          TOTAL_SIZE=$(find "${{ env.SOURCE_DIR }}" -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" \) -exec stat -c%s {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
        fi
        
        if [ -z "$TOTAL_SIZE" ]; then
          TOTAL_SIZE=0
        fi
        
        echo "Taille totale des assets: $((TOTAL_SIZE / 1024)) KB"
        
        if [ $TOTAL_SIZE -gt 100000000 ]; then  # > 100MB
          echo "‚ö†Ô∏è  ATTENTION: Taille totale > 100MB - GitHub Pages a des limites"
        fi
        
        # V√©rifier les liens externes
        echo ""
        echo "üîó V√©rification des liens externes..."
        if grep -r "http://" --include="*.html" --include="*.css" --include="*.js" "${{ env.SOURCE_DIR }}" 2>/dev/null | grep -v "http://localhost" | grep -v "http://127.0.0.1"; then
          echo "‚ö†Ô∏è  ATTENTION: Liens HTTP non s√©curis√©s d√©tect√©s"
        else
          echo "‚úÖ Tous les liens externes utilisent HTTPS ou sont locaux"
        fi
        
        # V√©rifier les erreurs 404 potentielles
        echo ""
        echo "üîç V√©rification des fichiers r√©f√©renc√©s..."
        HTML_FILES=$(find "${{ env.SOURCE_DIR }}" -name "*.html" -type f 2>/dev/null)
        
        for html_file in $HTML_FILES; do
          echo "Analyse de $html_file..."
          
          # Extraire les liens vers les assets locaux
          ASSETS=$(grep -o 'src="[^"]*"' "$html_file" 2>/dev/null | cut -d'"' -f2 | grep -v "^http" | grep -v "^//")
          ASSETS="$ASSETS $(grep -o 'href="[^"]*"' "$html_file" 2>/dev/null | cut -d'"' -f2 | grep -v "^http" | grep -v "^//" | grep -v "^mailto:" | grep -v "^tel:")"
          ASSETS="$ASSETS $(grep -o 'url([^)]*)' "$html_file" 2>/dev/null | sed "s/url('//;s/')//;s/url(\"//;s/\")//" | grep -v "^http" | grep -v "^//")"
          
          for asset in $ASSETS; do
            # Les assets sont r√©f√©renc√©s depuis la racine du site, donc on les cherche dans public/
            if [ ! -f "${{ env.SOURCE_DIR }}/$asset" ] && [ ! -d "${{ env.SOURCE_DIR }}/$asset" ]; then
              echo "‚ö†Ô∏è  Asset manquant dans $html_file: $asset"
            fi
          done
        done
        
        echo ""
        echo "‚úÖ Validation des fichiers termin√©e"

    - name: Check HTML validity
      run: |
        echo "üìã Validation de la qualit√© HTML..."
        echo "=========================================="
        
        MAIN_HTML="${{ env.SOURCE_DIR }}/index.html"
        
        if [ ! -f "$MAIN_HTML" ]; then
          echo "‚ùå ERREUR: $MAIN_HTML manquant"
          exit 1
        fi
        
        # V√©rifier les balises meta essentielles
        echo "üîç Balises meta SEO..."
        if grep -q "<meta name=\"description\"" "$MAIN_HTML"; then
          echo "‚úÖ Meta description pr√©sente"
        else
          echo "‚ö†Ô∏è  ATTENTION: Meta description manquante (impact SEO)"
        fi
        
        if grep -q "<meta name=\"keywords\"" "$MAIN_HTML"; then
          echo "‚úÖ Meta keywords pr√©sente"
        else
          echo "‚ÑπÔ∏è  Meta keywords optionnelle"
        fi
        
        if grep -q "<meta property=\"og:" "$MAIN_HTML"; then
          echo "‚úÖ Open Graph tags pr√©sentes"
        else
          echo "‚ö†Ô∏è  ATTENTION: Open Graph tags manquantes (r√©seaux sociaux)"
        fi
        
        # V√©rifier le favicon
        echo ""
        echo "üé® Favicon..."
        if grep -q "rel=\"icon\"" "$MAIN_HTML" || grep -q "rel=\"shortcut icon\"" "$MAIN_HTML"; then
          echo "‚úÖ Favicon d√©tect√©"
        else
          echo "‚ö†Ô∏è  ATTENTION: Favicon manquant"
        fi
        
        # V√©rifier les analytics/tracking (optionnel)
        echo ""
        echo "üìä Analytics..."
        if grep -q "google-analytics\|gtag\|analytics" "$MAIN_HTML"; then
          echo "‚úÖ Google Analytics/GTag d√©tect√©"
        elif grep -q "matomo\|piwik" "$MAIN_HTML"; then
          echo "‚úÖ Matomo/Piwik d√©tect√©"
        else
          echo "‚ÑπÔ∏è  Aucun outil d'analytics d√©tect√©"
        fi

    - name: Check performance metrics
      run: |
        echo "‚ö° Analyse des m√©triques de performance..."
        echo "=========================================="
        
        MAIN_HTML="${{ env.SOURCE_DIR }}/index.html"
        
        # V√©rifier les ressources bloquantes
        echo "üîç Scripts bloquants..."
        SYNC_SCRIPTS=$(grep -c '<script src=' "$MAIN_HTML")
        ASYNC_SCRIPTS=$(grep -c 'async' "$MAIN_HTML")
        DEFER_SCRIPTS=$(grep -c 'defer' "$MAIN_HTML")
        
        echo "Scripts synchrones: $SYNC_SCRIPTS"
        echo "Scripts async: $ASYNC_SCRIPTS"
        echo "Scripts defer: $DEFER_SCRIPTS"
        
        if [ $SYNC_SCRIPTS -gt 3 ]; then
          echo "‚ö†Ô∏è  ATTENTION: Trop de scripts synchrones ($SYNC_SCRIPTS) - impacte le LCP"
        fi
        
        # V√©rifier le CSS inline vs externe
        echo ""
        echo "üé® CSS..."
        STYLE_TAGS=$(grep -c '<style>' "$MAIN_HTML")
        LINK_CSS=$(grep -c 'rel="stylesheet"' "$MAIN_HTML")
        
        echo "Balises <style> inline: $STYLE_TAGS"
        echo "Feuilles de style externes: $LINK_CSS"
        
        if [ $STYLE_TAGS -gt 2 ]; then
          echo "‚ö†Ô∏è  ATTENTION: Trop de CSS inline - peut bloquer le rendu"
        fi
        
        # V√©rifier les images
        echo ""
        echo "üñºÔ∏è Images..."
        IMG_TAGS=$(grep -c '<img' "$MAIN_HTML")
        IMG_WITH_ALT=$(grep -c 'alt="' "$MAIN_HTML")
        
        echo "Total images: $IMG_TAGS"
        echo "Images avec attribut alt: $IMG_WITH_ALT"
        
        if [ $IMG_TAGS -gt 0 ] && [ $IMG_WITH_ALT -lt $IMG_TAGS ]; then
          echo "‚ö†Ô∏è  ATTENTION: Certaines images n'ont pas d'attribut alt (SEO/accessibilit√©)"
        fi

    - name: Create deployment report
      run: |
        echo "üìä Cr√©ation du rapport de d√©ploiement..."
        echo "=========================================="
        
        TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
        COMMIT_HASH=$(git rev-parse --short HEAD)
        COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
        COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
        
        cat > deployment-report.md << EOF
        # Rapport de D√©ploiement
        
        ## Informations G√©n√©rales
        - **Date/Heure**: $TIMESTAMP
        - **Environnement**: ${{ env.DEPLOY_ENV }}
        - **Commit**: $COMMIT_HASH
        - **Auteur**: $COMMIT_AUTHOR
        - **Message**: $COMMIT_MESSAGE
        - **Workflow**: ${{ github.workflow }}
        - **Run ID**: ${{ github.run_id }}
        - **Dossier source**: ${{ env.SOURCE_DIR }}
        
        ## M√©triques du Projet
        $(echo "Fichiers HTML: $(find "${{ env.SOURCE_DIR }}" -name "*.html" -type f 2>/dev/null | wc -l)")
        $(echo "Fichiers CSS: $(find "${{ env.SOURCE_DIR }}" -name "*.css" -type f 2>/dev/null | wc -l)")
        $(echo "Fichiers JS: $(find "${{ env.SOURCE_DIR }}" -name "*.js" -type f 2>/dev/null | wc -l)")
        $(echo "Images: $(find "${{ env.SOURCE_DIR }}" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -type f 2>/dev/null | wc -l)")
        
        ## Validation
        - ‚úÖ Dossier ${{ env.SOURCE_DIR }} valid√©
        - ‚úÖ Structure HTML valid√©e
        - ‚úÖ Assets v√©rifi√©s
        - ‚úÖ Performance analys√©e
        
        ## Prochaines √âtapes
        1. D√©ploiement sur GitHub Pages
        2. Invalidation du cache CDN
        3. Surveillance des m√©triques
        
        ## URL de D√©ploiement
        Une fois d√©ploy√©, le site sera disponible √†:
        \`https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\`
        
        ---
        *Rapport g√©n√©r√© automatiquement par le workflow de d√©ploiement*
        EOF
        
        echo "üìÑ Rapport g√©n√©r√©: deployment-report.md"
        cat deployment-report.md

    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment-report.md
        retention-days: 90

  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: validate-deployment
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download deployment report
      uses: actions/download-artifact@v4
      with:
        name: deployment-report
        path: ./

    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
    
    - name: Prepare build directory
      run: |
        echo "üìÅ Pr√©paration du dossier de build..."
        echo "Source: ${{ env.SOURCE_DIR }}/"
        echo "=========================================="
        
        # V√©rifier que le dossier source existe
        if [ ! -d "${{ env.SOURCE_DIR }}" ]; then
          echo "‚ùå ERREUR: Dossier source '${{ env.SOURCE_DIR }}' manquant"
          exit 1
        fi
        
        # Cr√©er un r√©pertoire temporaire pour le build
        mkdir -p _site_build
        
        echo "üìã Copie du dossier ${{ env.SOURCE_DIR }}..."
        
        # M√©thode 1: Copie r√©cursive avec rsync (plus fiable)
        if command -v rsync > /dev/null 2>&1; then
          echo "  üîß Utilisation de rsync pour la copie..."
          rsync -av "${{ env.SOURCE_DIR }}/" _site_build/ --exclude=".*" 2>/dev/null || echo "‚ö†Ô∏è  Rsync a rencontr√© des probl√®mes, tentative alternative..."
        fi
        
        # M√©thode 2: Copie avec find et cp (fallback)
        if [ ! "$(ls -A _site_build 2>/dev/null)" ]; then
          echo "  üîß Utilisation de find/cp pour la copie..."
          find "${{ env.SOURCE_DIR }}" -type f -exec cp --parents {} _site_build/ \; 2>/dev/null || true
        fi
        
        # M√©thode 3: Copie simple (dernier recours)
        if [ ! "$(ls -A _site_build 2>/dev/null)" ]; then
          echo "  üîß Copie simple..."
          cp -r "${{ env.SOURCE_DIR }}"/* _site_build/ 2>/dev/null || true
        fi
        
        # V√©rifier ce qui a √©t√© copi√©
        echo ""
        echo "üìÅ Structure du build:"
        if [ "$(ls -A _site_build 2>/dev/null)" ]; then
          find _site_build -type f | head -30 | sed 's/^/  üìÑ /'
          
          TOTAL_FILES=$(find _site_build -type f | wc -l)
          echo "Total fichiers dans le build: $TOTAL_FILES"
          
          # V√©rifier que index.html a √©t√© copi√©
          if [ ! -f "_site_build/index.html" ]; then
            echo "‚ùå ERREUR CRITIQUE: index.html non copi√© dans le build"
            echo "Tentative de copie manuelle..."
            cp "${{ env.SOURCE_DIR }}/index.html" _site_build/
            
            if [ ! -f "_site_build/index.html" ]; then
              echo "‚ùå Impossible de copier index.html - d√©ploiement impossible"
              exit 1
            else
              echo "‚úÖ index.html copi√© manuellement"
            fi
          fi
        else
          echo "‚ùå ERREUR CRITIQUE: Aucun fichier copi√© - dossier source vide ou probl√®me de permissions"
          echo "Contenu du dossier source:"
          ls -la "${{ env.SOURCE_DIR }}"/
          exit 1
        fi
        
        # Ajouter un fichier CNAME si pr√©sent √† la racine
        if [ -f "CNAME" ]; then
          echo "  üåê CNAME d√©tect√© √† la racine"
          cp CNAME _site_build/
        fi
        
        # Ajouter un 404.html personnalis√© si absent
        if [ ! -f "_site_build/404.html" ]; then
          echo "  üîß Cr√©ation d'une page 404 basique..."
          cat > _site_build/404.html << EOF
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Page non trouv√©e - DevOps Pipeline</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                  h1 { color: #333; }
                  p { color: #666; }
                  a { color: #2563eb; text-decoration: none; }
              </style>
          </head>
          <body>
              <h1>404 - Page non trouv√©e</h1>
              <p>La page que vous recherchez n'existe pas.</p>
              <p><a href="/">Retour √† l'accueil</a></p>
              <p><small>DevOps Pipeline CI/CD - ${{ github.sha }}</small></p>
          </body>
          </html>
          EOF
        fi
        
        # Cr√©er un fichier README pour GitHub Pages
        cat > _site_build/README_DEPLOYMENT.md << EOF
        # Site DevOps Pipeline
        
        Ce site a √©t√© d√©ploy√© automatiquement via GitHub Actions.
        
        ## Informations
        - **Dernier commit**: ${{ github.sha }}
        - **Date de d√©ploiement**: $(date)
        - **Environnement**: ${{ env.DEPLOY_ENV }}
        - **Workflow**: ${{ github.workflow }}
        - **Dossier source**: ${{ env.SOURCE_DIR }}
        
        ## Structure
        Ce site utilise:
        - HTML5/CSS3/JavaScript
        - GitHub Pages pour l'h√©bergement
        - CI/CD automatique
        
        ## Maintenance
        Pour mettre √† jour le site:
        1. Modifier les fichiers dans ${{ env.SOURCE_DIR }}/
        2. Pusher les changements
        3. Le d√©ploiement se fera automatiquement
        
        ---
        *G√©n√©r√© automatiquement par le workflow de d√©ploiement*
        EOF
        
        echo ""
        echo "üìä Taille du build: $(du -sh _site_build 2>/dev/null || echo "inconnue")"
        echo "‚úÖ Pr√©paration termin√©e"

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site_build
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        timeout: 600000  # 10 minutes timeout
    
    - name: Verify deployment
      run: |
        echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
        echo ""
        echo "üìä R√âSUM√â DU D√âPLOIEMENT"
        echo "========================"
        echo "üåê URL du site: ${{ steps.deployment.outputs.page_url }}"
        echo "üÜî Commit: ${{ github.sha }}"
        echo "üë§ D√©clench√© par: ${{ github.actor }}"
        echo "‚è∞ Heure: $(date)"
        echo "üìÅ Source: ${{ env.SOURCE_DIR }}/"
        echo ""
        echo "üîß Actions recommand√©es:"
        echo "  1. Visiter ${{ steps.deployment.outputs.page_url }} pour v√©rifier"
        echo "  2. V√©rifier la console navigateur pour les erreurs"
        echo "  3. Tester les fonctionnalit√©s principales"
        echo "  4. Surveiller les m√©triques de performance"
        echo ""
        echo "üìà Prochaines √©tapes:"
        echo "  - Surveillance des logs (24-48h)"
        echo "  - Collecte des feedbacks utilisateurs"
        echo "  - Optimisation continue"
        
        # G√©n√©rer un QR code pour l'URL (optionnel)
        echo ""
        echo "üì± QR Code pour mobile:"
        echo "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${{ steps.deployment.outputs.page_url }}"

    - name: Create deployment summary
      if: always()
      run: |
        echo "üìã Cr√©ation du r√©sum√© de d√©ploiement..."
        
        DEPLOYMENT_STATUS=${{ job.status }}
        DEPLOYMENT_URL=${{ steps.deployment.outputs.page_url }}
        
        cat > deployment-summary.md << EOF
        # R√©sum√© du D√©ploiement
        
        ## Statut: $(if [ "$DEPLOYMENT_STATUS" = "success" ]; then echo "‚úÖ SUCC√àS"; else echo "‚ùå √âCHEC"; fi)
        
        ## D√©tails
        - **URL**: $DEPLOYMENT_URL
        - **Commit**: \`${{ github.sha }}\`
        - **Branche**: \`${{ github.ref_name }}\`
        - **Auteur**: ${{ github.actor }}
        - **Date**: $(date)
        - **Dossier source**: ${{ env.SOURCE_DIR }}
        
        ## Validation
        - ‚úÖ Dossier source valid√©
        - ‚úÖ Assets v√©rifi√©s
        - ‚úÖ Performance analys√©e
        $(if [ "$DEPLOYMENT_STATUS" = "success" ]; then echo "- ‚úÖ D√©ploy√© avec succ√®s"; else echo "- ‚ùå √âchec du d√©ploiement"; fi)
        
        ## Surveillance
        Surveillez les m√©triques suivantes:
        1. Temps de chargement initial
        2. Erreurs console
        3. Exp√©rience utilisateur
        
        ## Support
        En cas de probl√®me:
        1. Consulter les logs GitHub Actions
        2. V√©rifier l'URL: $DEPLOYMENT_URL
        3. Ouvrir une issue si n√©cessaire
        EOF
        
        echo "üìÑ R√©sum√© g√©n√©r√©"

    - name: Upload deployment summary
      uses: actions/upload-artifact@v4
      with:
        name: deployment-summary
        path: deployment-summary.md
        retention-days: 30

    - name: Notify deployment status
      if: always()
      run: |
        echo "üì¢ Notification du statut de d√©ploiement..."
        echo ""
        
        DEPLOYMENT_STATUS=${{ job.status }}
        DEPLOYMENT_URL=${{ steps.deployment.outputs.page_url }}
        
        if [ "$DEPLOYMENT_STATUS" = "success" ]; then
          echo "üéâ D√âPLOIEMENT R√âUSSI!"
          echo ""
          echo "Le site DevOps Pipeline a √©t√© d√©ploy√© avec succ√®s."
          echo ""
          echo "üîó Acc√©der au site:"
          echo "$DEPLOYMENT_URL"
          echo ""
          echo "üìä M√©triques:"
          echo "- Site disponible en production"
          echo "- CDN GitHub Pages activ√©"
          echo "- HTTPS automatique"
          echo "- Surveillance en cours"
          echo "- Dossier source: ${{ env.SOURCE_DIR }}/"
        else
          echo "‚ùå D√âPLOIEMENT √âCHOU√â"
          echo ""
          echo "Le d√©ploiement a rencontr√© une erreur."
          echo ""
          echo "üîß Actions recommand√©es:"
          echo "1. V√©rifier les logs du workflow"
          echo "2. V√©rifier le dossier ${{ env.SOURCE_DIR }}/"
          echo "3. Corriger les probl√®mes identifi√©s"
          echo "4. Relancer le d√©ploiement"
          echo ""
          echo "‚ö†Ô∏è  Le site pr√©c√©dent reste disponible"
        fi