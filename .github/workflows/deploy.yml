name: Deploy to GitHub Pages

on:
  push:
    branches: [main,dev]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write
  contents: read

env:
  SOURCE_DIR: public  # Dossier source pour le d√©ploiement

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: V√©rifier le dossier source
      run: |
        echo "üîç V√©rification du dossier ${{ env.SOURCE_DIR }}/..."
        
        if [ ! -d "${{ env.SOURCE_DIR }}" ]; then
          echo "‚ö†Ô∏è  Dossier '${{ env.SOURCE_DIR }}/' manquant - cr√©ation d'un exemple"
          mkdir -p "${{ env.SOURCE_DIR }}"
          
          # Cr√©er un index.html minimal
          cat > "${{ env.SOURCE_DIR }}/index.html" << EOF
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>DevOps Pipeline CI/CD</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                  h1 { color: #2563eb; }
                  p { color: #6b7280; }
              </style>
          </head>
          <body>
              <h1>DevOps Pipeline CI/CD</h1>
              <p>Site statique d√©ploy√© via GitHub Pages</p>
              <p><small>Version: ${{ github.sha }}</small></p>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Exemple cr√©√© dans ${{ env.SOURCE_DIR }}/index.html"
        else
          echo "‚úÖ Dossier '${{ env.SOURCE_DIR }}/' pr√©sent"
          
          # V√©rifier index.html
          if [ ! -f "${{ env.SOURCE_DIR }}/index.html" ]; then
            echo "‚ö†Ô∏è  index.html manquant - cr√©ation d'un exemple"
            cat > "${{ env.SOURCE_DIR }}/index.html" << EOF
            <!DOCTYPE html>
            <html lang="fr">
            <head>
                <meta charset="UTF-8">
                <title>DevOps Pipeline</title>
            </head>
            <body>
                <h1>Site DevOps Pipeline</h1>
                <p>Commit: ${{ github.sha }}</p>
            </body>
            </html>
            EOF
          else
            echo "‚úÖ index.html pr√©sent"
          fi
        fi
        
        echo ""
        echo "üìÅ Contenu de ${{ env.SOURCE_DIR }}/ :"
        find "${{ env.SOURCE_DIR }}" -type f | head -10 | sed 's/^/  üìÑ /'
    
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: "${{ env.SOURCE_DIR }}"  # ‚úÖ Upload du dossier public/
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Show deployment info
      run: |
        echo "‚úÖ D√âPLOIEMENT R√âUSSI !"
        echo ""
        echo "üåê URL du site:"
        echo "${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "üìä D√©tails:"
        echo "- Commit: ${{ github.sha }}"
        echo "- Branche: ${{ github.ref_name }}"
        echo "- D√©clench√© par: ${{ github.actor }}"
        echo "- Dossier source: ${{ env.SOURCE_DIR }}/"
        echo ""
        echo "üîó Acc√©der au site:"
        echo "${{ steps.deployment.outputs.page_url }}"