name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. R√âCUP√âRER LE BUILD (Point 1 de la consigne)
    - name: Checkout and prepare build
      uses: actions/checkout@v4
    
    - name: Check for build artifacts
      run: |
        echo "üîç Looking for build artifacts..."
        
        # V√©rifier les dossiers de build courants
        if [ -d "dist" ]; then
          echo "üì¶ Found dist/ directory"
          echo "Copying to public/"
          mkdir -p public
          cp -r dist/* public/ 2>/dev/null || true
        elif [ -d "build" ]; then
          echo "üì¶ Found build/ directory"
          echo "Copying to public/"
          mkdir -p public
          cp -r build/* public/ 2>/dev/null || true
        elif [ -d "out" ]; then
          echo "üì¶ Found out/ directory"
          echo "Copying to public/"
          mkdir -p public
          cp -r out/* public/ 2>/dev/null || true
        fi
        
        # Cr√©er public/ s'il n'existe pas
        if [ ! -d "public" ]; then
          echo "üìÅ Creating public/ directory"
          mkdir -p public
        fi
        
        # Cr√©er un fichier minimal si vide
        if [ ! -f "public/index.html" ] && [ ! -f "public/index.htm" ]; then
          echo "üìÑ Creating minimal index.html"
          echo "<h1>DevOps CD Pipeline</h1><p>Deployed via GitHub Actions</p>" > public/index.html
        fi
    
    # 2. OPTIMISATION POUR GITHUB PAGES
    - name: Ensure JS works on GitHub Pages
      run: |
        echo "üîß Configuration pour GitHub Pages..."
        
        # Juste corriger les slashs initiaux
        if [ -f "public/index.html" ]; then
          echo "Fixing paths in index.html..."
          sed -i.bak 's|="/|="|g' public/index.html
          sed -i.bak 's|src="/|src="|g' public/index.html
          sed -i.bak 's|href="/|href="|g' public/index.html
          rm -f public/index.html.bak 2>/dev/null || true
        fi
        
        # V√©rifier les fichiers
        echo ""
        echo "üìä Fichiers pr√©sents:"
        ls -la public/ 2>/dev/null || echo "Dossier public/ vide"
    
    # 3. D√âPLOIEMENT AUTOMATIQUE (Point 2 de la consigne)
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "public"
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    # 4. NOTIFICATIONS (Point 3 de la consigne)
    - name: Send GitHub deployment status
      uses: actions/github-script@v7
      if: success()
      with:
        script: |
          // Cr√©er un statut de d√©ploiement
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: context.payload.deployment?.id || context.runId,
            state: 'success',
            environment_url: '${{ steps.deployment.outputs.page_url }}',
            description: 'Successfully deployed to GitHub Pages',
            auto_inactive: true
          });
          
          console.log('‚úÖ GitHub deployment status updated');
    
    - name: Send Discord notification
      if: success() && env.DISCORD_WEBHOOK_URL
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "üì¢ Sending Discord notification..."
        curl -H "Content-Type: application/json" \
             -X POST \
             -d '{"content": "‚úÖ **D√©ploiement GitHub Pages R√©ussi**\nüåê URL: ${{ steps.deployment.outputs.page_url }}\nüîó Commit: ${{ github.sha }}\nüìÖ $(date)"}' \
             "$DISCORD_WEBHOOK_URL" || echo "‚ö†Ô∏è Discord notification failed"
    
    - name: Send Slack notification
      if: success() && env.SLACK_WEBHOOK_URL
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "üì¢ Sending Slack notification..."
        curl -X POST \
             -H 'Content-type: application/json' \
             --data '{"text": "‚úÖ D√©ploiement GitHub Pages r√©ussi\n‚Ä¢ URL: ${{ steps.deployment.outputs.page_url }}\n‚Ä¢ Commit: ${{ github.sha }}"}' \
             "$SLACK_WEBHOOK_URL" || echo "‚ö†Ô∏è Slack notification failed"
    
    # 5. CONFIRMATION FINALE
    - name: Success message
      run: |
        echo "üéâ D√âPLOIEMENT R√âUSSI !"
        echo ""
        echo "üåê URL: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "üìä D√©tails du d√©ploiement:"
        echo "‚Ä¢ Commit: ${{ github.sha }}"
        echo "‚Ä¢ Branche: ${{ github.ref_name }}"
        echo "‚Ä¢ D√©clench√© par: ${{ github.actor }}"
        echo "‚Ä¢ Environnement: github-pages"
        echo "‚Ä¢ Date: $(date '+%d/%m/%Y %H:%M:%S')"
        echo ""
        echo "‚úÖ Points valid√©s:"
        echo "1. ‚úì R√©cup√©ration du build/artefacts"
        echo "2. ‚úì D√©ploiement automatique sur GitHub Pages"
        echo "3. ‚úì Notifications envoy√©es"
        echo ""
        echo "üîß Votre JavaScript devrait fonctionner car:"
        echo "‚Ä¢ Les chemins ont √©t√© corrig√©s"
        echo "‚Ä¢ GitHub Pages sert les fichiers statiques"
        echo ""
        echo "üîç Pour d√©boguer:"
        echo "1. Ouvrir la console navigateur (F12)"
        echo "2. V√©rifier les chemins dans index.html"
        echo "3. Consulter les logs de ce workflow"