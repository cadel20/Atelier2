name: Deploy to GitHub Pages

on:
  push:
    branches: [main,dev]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: VÃ©rifier dossier public
      run: |
        echo "ğŸ” VÃ©rification du dossier public/..."
        
        if [ ! -d "public" ]; then
          echo "âš ï¸  Dossier 'public/' manquant - crÃ©ation d'un exemple"
          mkdir -p "public"
          
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>DevOps Pipeline CI/CD</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                  h1 { color: #2563eb; }
                  p { color: #6b7280; }
              </style>
          </head>
          <body>
              <h1>DevOps Pipeline CI/CD</h1>
              <p>Site statique dÃ©ployÃ© via GitHub Pages</p>
              <p><small>Version: ${{ github.sha }}</small></p>
          </body>
          </html>
          EOF
          
          echo "âœ… Exemple crÃ©Ã© dans public/index.html"
        else
          echo "âœ… Dossier 'public/' prÃ©sent"
          
          if [ ! -f "public/index.html" ]; then
            echo "âš ï¸  index.html manquant - crÃ©ation d'un exemple"
            cat > public/index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="fr">
            <head>
                <meta charset="UTF-8">
                <title>DevOps Pipeline</title>
            </head>
            <body>
                <h1>Site DevOps Pipeline</h1>
                <p>Commit: ${{ github.sha }}</p>
            </body>
            </html>
            EOF
          else
            echo "âœ… index.html prÃ©sent"
          fi
        fi
        
        echo ""
        echo "ğŸ“ Contenu de public/ :"
        find public -type f | head -10 | sed 's/^/  ğŸ“„ /'
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "public"
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: RÃ©sultat
      run: |
        echo "âœ… DÃ‰PLOIEMENT RÃ‰USSI !"
        echo ""
        echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“Š DÃ©tails:"
        echo "- Commit: ${{ github.sha }}"
        echo "- Branche: ${{ github.ref_name }}"
        echo "- DÃ©clenchÃ© par: ${{ github.actor }}"