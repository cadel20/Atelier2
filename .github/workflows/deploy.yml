name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Fix ALL paths (CSS + JS + Resources)
      run: |
        echo "ğŸ”§ CORRECTION COMPLÃˆTE DES CHEMINS..."
        echo "======================================"
        
        # 1. VÃ©rifier que public/ existe
        if [ ! -d "public" ]; then
          echo "âŒ ERREUR: Dossier 'public/' manquant"
          echo "   Structure attendue:"
          echo "   public/"
          echo "   â”œâ”€â”€ index.html"
          echo "   â”œâ”€â”€ css/"
          echo "   â”‚   â”œâ”€â”€ style.css"
          echo "   â”‚   â””â”€â”€ responsive.css"
          echo "   â””â”€â”€ js/"
          echo "       â””â”€â”€ [vos fichiers .js]"
          exit 1
        fi
        
        # 2. CORRECTION DU HTML (CSS + JS)
        echo ""
        echo "ğŸ“„ Correction de index.html..."
        
        if [ -f "public/index.html" ]; then
          # Backup du fichier original
          cp public/index.html public/index.html.backup
          
          # A. Correction des chemins CSS
          echo "  ğŸ¨ Correction CSS..."
          sed -i 's|href="/css/|href="css/|g' public/index.html
          sed -i 's|href="css/style.css"|href="css/style.css"|g' public/index.html
          sed -i 's|href="css/responsive.css"|href="css/responsive.css"|g' public/index.html
          
          # Ajouter responsive.css s'il manque
          if ! grep -q "responsive.css" public/index.html; then
            echo "  â• Ajout de responsive.css..."
            sed -i '/style.css/ a\    <link rel="stylesheet" href="css/responsive.css">' public/index.html
          fi
          
          # B. Correction des chemins JavaScript
          echo "  âš¡ Correction JavaScript..."
          sed -i 's|src="/js/|src="js/|g' public/index.html
          sed -i 's|src="js/|src="js/|g' public/index.html
          
          # VÃ©rifier et ajouter les scripts JS manquants
          JS_FILES=$(find public/js -name "*.js" 2>/dev/null | head -5)
          
          # Compteur pour voir quels JS sont ajoutÃ©s
          js_added=0
          
          for js_file in $JS_FILES; do
            js_name=$(basename "$js_file")
            if ! grep -q "$js_name" public/index.html; then
              echo "  â• Ajout de $js_name..."
              sed -i '/<\/head>/i\    <script src="js/'"$js_name"'"></script>' public/index.html
              js_added=$((js_added + 1))
            fi
          done
          
          if [ $js_added -eq 0 ] && [ -n "$JS_FILES" ]; then
            echo "  âœ… Tous les fichiers JS sont dÃ©jÃ  rÃ©fÃ©rencÃ©s"
          fi
          
          # Ajouter un script de base si aucun JS n'existe
          if [ -z "$JS_FILES" ] && ! grep -q "<script src=" public/index.html; then
            echo "  ğŸ“ CrÃ©ation d'un script JS de base..."
            mkdir -p public/js
            cat > public/js/app.js << 'EOF'
// DevOps Pipeline CI/CD - JavaScript de base
console.log('ğŸš€ DevOps Pipeline JS chargÃ© avec succÃ¨s!');

// VÃ©rifier que le DOM est chargÃ©
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… DOM complÃ¨tement chargÃ©');
    
    // Afficher un message de bienvenue
    const welcomeMessage = document.createElement('div');
    welcomeMessage.style.cssText = `
        background: linear-gradient(45deg, #2563eb, #7c3aed);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    `;
    welcomeMessage.innerHTML = `
        <h3>ğŸ‰ JavaScript Fonctionnel!</h3>
        <p>Le JS est correctement chargÃ© et exÃ©cutÃ©.</p>
        <button onclick="showDemoAlert()" style="
            background: white;
            color: #2563eb;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        ">Tester le JS</button>
    `;
    
    // InsÃ©rer au dÃ©but du body
    document.body.insertBefore(welcomeMessage, document.body.firstChild);
    
    // Mettre Ã  jour la date
    updateDate();
});

// Fonction de dÃ©monstration
function showDemoAlert() {
    alert('âœ… JavaScript opÃ©rationnel!\n\nLe pipeline CI/CD fonctionne parfaitement avec:\nâ€¢ HTML\nâ€¢ CSS\nâ€¢ JavaScript');
}

// Mettre Ã  jour la date et heure
function updateDate() {
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
        const now = new Date();
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        dateElement.textContent = now.toLocaleDateString('fr-FR', options);
    }
}

// Exporter les fonctions (si besoin de modules)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { showDemoAlert, updateDate };
}
EOF
            
            # Ajouter le script Ã  index.html
            sed -i '/<\/body>/i\    <script src="js/app.js"></script>' public/index.html
            echo "  âœ… app.js crÃ©Ã© et ajoutÃ©"
          fi
          
          # C. Ajouter base href pour GitHub Pages
          if ! grep -q "<base href" public/index.html; then
            echo "  ğŸŒ Ajout de base href..."
            sed -i '/<head>/a\    <base href="./">' public/index.html
          fi
          
          echo "âœ… index.html corrigÃ© avec succÃ¨s"
          echo ""
          echo "ğŸ”— Liens vÃ©rifiÃ©s:"
          echo "CSS:"
          grep -i "href.*css" public/index.html | sed 's/^/  /'
          echo "JavaScript:"
          grep -i "src.*js" public/index.html | sed 's/^/  /'
          
        else
          echo "âŒ public/index.html manquant - crÃ©ation..."
          mkdir -p public/css public/js
          
          # CrÃ©er un index.html complet
          cat > public/index.html << 'EOF'
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Pipeline CI/CD</title>
    <base href="./">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš€</text></svg>">
</head>
<body>
    <div class="container">
        <h1>ğŸš€ DevOps Pipeline CI/CD</h1>
        <div class="status success">
            âœ… CSS et JavaScript chargÃ©s avec succÃ¨s
        </div>
        
        <div class="demo">
            <h3>Test JavaScript</h3>
            <button onclick="testJavaScript()" class="btn">
                Cliquer pour tester le JS
            </button>
            <p id="js-result"></p>
        </div>
        
        <div class="info">
            <p><strong>Commit:</strong> ${{ github.sha }}</p>
            <p><strong>DÃ©ployÃ© le:</strong> <span id="current-date">...</span></p>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="js/app.js"></script>
    <script>
        // Script inline de test
        function testJavaScript() {
            document.getElementById('js-result').textContent = 
                'âœ… JavaScript fonctionne! ' + new Date().toLocaleTimeString();
            alert('JavaScript opÃ©rationnel!');
        }
        
        // Date actuelle
        document.getElementById('current-date').textContent = 
            new Date().toLocaleDateString('fr-FR');
    </script>
</body>
</html>
EOF
          
          echo "âœ… index.html crÃ©Ã© avec JS intÃ©grÃ©"
        fi
        
        # 3. VÃ‰RIFICATION DE LA STRUCTURE
        echo ""
        echo "ğŸ“ Structure finale de public/:"
        find public -type f | sed 's/^/  ğŸ“„ /' 2>/dev/null | head -20
        
        echo ""
        echo "ğŸ” Fichiers JavaScript trouvÃ©s:"
        find public -name "*.js" 2>/dev/null | sed 's/^/  âš¡ /'
        
        echo ""
        echo "ğŸ¨ Fichiers CSS trouvÃ©s:"
        find public -name "*.css" 2>/dev/null | sed 's/^/  ğŸ¨ /'
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "public"
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Verify complete deployment
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT COMPLET RÃ‰USSI !"
        echo ""
        echo "ğŸŒ SITE WEB:"
        echo "${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ğŸ“¦ RESSOURCES DÃ‰PLOYÃ‰ES:"
        echo ""
        echo "ğŸ¨ CSS:"
        echo "   â€¢ ${{ steps.deployment.outputs.page_url }}css/style.css"
        echo "   â€¢ ${{ steps.deployment.outputs.page_url }}css/responsive.css"
        echo ""
        echo "âš¡ JAVASCRIPT:"
        
       