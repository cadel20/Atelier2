name: Deploy to GitHub Pages

on:
  push:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

env:
  SOURCE_DIR: public

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Verify source directory
      run: |
        echo "ğŸ” Checking ${{ env.SOURCE_DIR }}/ directory..."
        
        if [ ! -d "${{ env.SOURCE_DIR }}" ]; then
          echo "ğŸ“ Creating ${{ env.SOURCE_DIR }}/ directory..."
          mkdir -p "${{ env.SOURCE_DIR }}"
          cat > "${{ env.SOURCE_DIR }}/index.html" << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
              <meta charset="UTF-8">
              <title>DevOps Pipeline</title>
          </head>
          <body>
              <h1>DevOps Pipeline CI/CD</h1>
              <p>Auto-deployed via GitHub Actions</p>
              <p><small>Commit: ${{ github.sha }}</small></p>
          </body>
          </html>
          EOF
          echo "âœ… Created example site"
        elif [ ! -f "${{ env.SOURCE_DIR }}/index.html" ]; then
          echo "âš ï¸  index.html missing, creating basic version"
          echo '<h1>DevOps Pipeline</h1><p>Commit: ${{ github.sha }}</p>' > "${{ env.SOURCE_DIR }}/index.html"
        fi
        
        echo "ğŸ“Š Content of ${{ env.SOURCE_DIR }}/:"
        ls -la "${{ env.SOURCE_DIR }}/" || echo "Directory is empty"
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "${{ env.SOURCE_DIR }}"
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Show result
      run: |
        echo "âœ… SITE DEPLOYED!"
        echo "ğŸ”— ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“ Source: ${{ env.SOURCE_DIR }}/"
        echo "ğŸ†” ${{ github.sha }}"