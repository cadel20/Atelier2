name: CI Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Validate & Build
    env:
      NODE_ENV: ci
      SOURCE_DIR: public  # Dossier source pour les fichiers statiques

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --no-audit --prefer-offline
        env:
          NODE_ENV: development

      - name: Validate project structure
        run: |
          echo "ğŸ” Validation de la structure du projet..."
          echo "=========================================="
          
          # VÃ©rifier l'existence du dossier public
          if [ ! -d "${{ env.SOURCE_DIR }}" ]; then
            echo "âŒ ERREUR CRITIQUE: Dossier '${{ env.SOURCE_DIR }}' manquant"
            echo "Votre projet doit contenir un dossier '${{ env.SOURCE_DIR }}/' avec les fichiers statiques"
            exit 1
          fi
          echo "âœ… Dossier '${{ env.SOURCE_DIR }}/' prÃ©sent"
          
          # VÃ©rifier les fichiers essentiels dans public/
          REQUIRED_FILES=("${{ env.SOURCE_DIR }}/index.html" "package.json")
          missing_files=0
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ERREUR CRITIQUE: $file manquant"
              missing_files=$((missing_files + 1))
            else
              echo "âœ… $file prÃ©sent"
            fi
          done
          
          if [ $missing_files -gt 0 ]; then
            echo ""
            echo "âŒ $missing_files fichier(s) manquant(s) - pipeline impossible"
            exit 1
          fi

      - name: Validate HTML structure
        run: |
          echo "ğŸ” Validation de la structure HTML..."
          echo "=========================================="
          
          HTML_FILE="${{ env.SOURCE_DIR }}/index.html"
          
          if [ ! -f "$HTML_FILE" ]; then
            echo "âŒ ERREUR CRITIQUE: $HTML_FILE manquant"
            exit 1
          fi
          
          # Validation approfondie d'index.html
          echo ""
          echo "ğŸ“‹ Validation de $HTML_FILE..."
          
          # VÃ©rifier le doctype (CRITIQUE)
          if ! grep -q "^<!DOCTYPE html>" "$HTML_FILE"; then
            echo "âŒ ERREUR CRITIQUE: Doctype HTML5 manquant"
            exit 1
          fi
          echo "âœ… Doctype HTML5 prÃ©sent"
          
          # VÃ©rifier les balises essentielles
          ESSENTIAL_TAGS=("html lang=" "head" "body" "title" "meta charset=" "meta name=\"viewport\"")
          missing_tags=0
          
          for tag in "${ESSENTIAL_TAGS[@]}"; do
            if ! grep -q "$tag" "$HTML_FILE"; then
              echo "âš ï¸  ATTENTION: '$tag' manquant ou incorrect"
              ((missing_tags++))
            else
              echo "âœ… '$tag' prÃ©sent"
            fi
          done
          
          # VÃ©rifier les balises de fermeture
          echo ""
          echo "ğŸ”’ VÃ©rification des balises fermantes..."
          if ! grep -q "</html>" "$HTML_FILE"; then
            echo "âš ï¸  ATTENTION: Balise </html> manquante"
            ((missing_tags++))
          fi
          if ! grep -q "</body>" "$HTML_FILE"; then
            echo "âš ï¸  ATTENTION: Balise </body> manquante"
            ((missing_tags++))
          fi
          
          # VÃ©rifier la taille du fichier
          echo ""
          echo "ğŸ“ Analyse de la taille..."
          FILE_SIZE=$(stat -f%z "$HTML_FILE" 2>/dev/null || stat -c%s "$HTML_FILE" 2>/dev/null)
          echo "Taille de $HTML_FILE: $FILE_SIZE octets"
          
          if [ $FILE_SIZE -lt 1000 ]; then
            echo "âš ï¸  ATTENTION: Fichier trÃ¨s petit (<1KB) - possible erreur"
          elif [ $FILE_SIZE -gt 500000 ]; then
            echo "âš ï¸  ATTENTION: Fichier trÃ¨s grand (>500KB) - optimisation recommandÃ©e"
          else
            echo "âœ… Taille optimale"
          fi
          
          # VÃ©rifier les ressources externes
          echo ""
          echo "ğŸŒ VÃ©rification des ressources..."
          if grep -q "http://" "$HTML_FILE"; then
            echo "âš ï¸  ATTENTION: Liens HTTP non sÃ©curisÃ©s dÃ©tectÃ©s (prÃ©fÃ©rez HTTPS)"
          fi
          
          # VÃ©rifier les scripts et styles
          SCRIPT_COUNT=$(grep -c "<script" "$HTML_FILE")
          STYLE_COUNT=$(grep -c "<style\|\.css" "$HTML_FILE")
          echo "Scripts dÃ©tectÃ©s: $SCRIPT_COUNT"
          echo "Styles dÃ©tectÃ©s: $STYLE_COUNT"
          
          # RÃ©sumÃ©
          echo ""
          echo "=========================================="
          if [ $missing_tags -gt 0 ]; then
            echo "âš ï¸  Validation terminÃ©e avec $missing_tags avertissement(s)"
          else
            echo "âœ… Validation HTML rÃ©ussie"
          fi

      - name: Validate assets in public directory
        run: |
          echo "ğŸ“ Validation des assets dans ${{ env.SOURCE_DIR }}/..."
          echo "=========================================="
          
          # VÃ©rifier les sous-dossiers communs
          COMMON_SUBDIRS=("css" "js" "images" "assets")
          
          for subdir in "${COMMON_SUBDIRS[@]}"; do
            if [ -d "${{ env.SOURCE_DIR }}/$subdir" ]; then
              echo "âœ… Sous-dossier $subdir/ prÃ©sent"
              
              # Compter les fichiers
              FILE_COUNT=$(find "${{ env.SOURCE_DIR }}/$subdir" -type f 2>/dev/null | wc -l)
              echo "   ğŸ“Š $FILE_COUNT fichier(s)"
            else
              echo "â„¹ï¸  Sous-dossier $subdir/ absent (optionnel)"
            fi
          done
          
          # Lister tous les fichiers dans public/
          echo ""
          echo "ğŸ“‹ Liste des fichiers dans ${{ env.SOURCE_DIR }}/:"
          find "${{ env.SOURCE_DIR }}" -type f 2>/dev/null | sort | sed 's/^/  ğŸ“„ /' | head -20
          
          TOTAL_FILES=$(find "${{ env.SOURCE_DIR }}" -type f 2>/dev/null | wc -l)
          echo ""
          echo "ğŸ“Š Total fichiers: $TOTAL_FILES"
          
          if [ $TOTAL_FILES -eq 0 ]; then
            echo "âš ï¸  ATTENTION: Dossier ${{ env.SOURCE_DIR }}/ vide"
          fi

      - name: Check package.json structure
        run: |
          echo "ğŸ“¦ Validation de package.json..."
          echo "=========================================="
          
          # VÃ©rifier les champs essentiels
          REQUIRED_FIELDS=("name" "version" "description")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! grep -q "\"$field\"" package.json; then
              echo "âš ï¸  ATTENTION: Champ '$field' manquant dans package.json"
            else
              echo "âœ… '$field' prÃ©sent"
            fi
          done
          
          # VÃ©rifier les scripts
          echo ""
          echo "âš¡ Scripts disponibles:"
          if grep -q '"scripts"' package.json; then
            npm run
          else
            echo "â„¹ï¸  Aucun script dÃ©fini"
          fi

      - name: Run linter (si configurÃ©)
        run: |
          echo "ğŸ§¹ ExÃ©cution du linter..."
          if [ -f ".eslintrc" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            echo "ESLint configurÃ© - exÃ©cution..."
            npx eslint . --ext .js || echo "âš ï¸  ESLint a trouvÃ© des problÃ¨mes"
          else
            echo "â„¹ï¸  ESLint non configurÃ©"
          fi

      - name: Run tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests..."
          echo "=========================================="
          
          # VÃ©rifier si des tests sont configurÃ©s
          if npm run | grep -q " test "; then
            echo "Tests dÃ©tectÃ©s - exÃ©cution..."
            npm test
            TEST_RESULT=$?
            
            if [ $TEST_RESULT -eq 0 ]; then
              echo "âœ… Tous les tests ont rÃ©ussi"
            else
              echo "âŒ Certains tests ont Ã©chouÃ©"
              exit $TEST_RESULT
            fi
          else
            echo "â„¹ï¸  Aucun script de test trouvÃ©"
            echo "âœ… Tests simulÃ©s - status OK"
          fi

      - name: Build application
        run: |
          echo "ğŸ—ï¸  Construction de l'application..."
          echo "=========================================="
          
          # CrÃ©er le dossier de build
          BUILD_DIR="dist"
          echo "CrÃ©ation du dossier: $BUILD_DIR"
          mkdir -p $BUILD_DIR
          
          # Copier le dossier public/ vers dist/
          echo "ğŸ“ Copie de ${{ env.SOURCE_DIR }}/ vers $BUILD_DIR/"
          
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cp -r "${{ env.SOURCE_DIR }}"/* $BUILD_DIR/ 2>/dev/null || true
            echo "âœ… ${{ env.SOURCE_DIR }}/ copiÃ©"
          else
            echo "âŒ ERREUR: ${{ env.SOURCE_DIR }}/ manquant"
            exit 1
          fi
          
          # Copier package.json et autres fichiers importants
          echo "ğŸ“„ Copie des fichiers de configuration..."
          for file in "package.json" "README.md" "LICENSE"; do
            if [ -f "$file" ]; then
              cp "$file" $BUILD_DIR/
              echo "âœ… $file copiÃ©"
            fi
          done
          
          # Afficher la structure du build
          echo ""
          echo "ğŸ“‚ Structure du dossier $BUILD_DIR:"
          find $BUILD_DIR -type f | sort | sed 's/^/  /' | head -30
          echo ""
          echo "ğŸ“Š Taille totale: $(du -sh $BUILD_DIR | cut -f1)"

      - name: Security scan
        run: |
          echo "ğŸ”’ Scan de sÃ©curitÃ©..."
          echo "=========================================="
          
          # VÃ©rifier les dÃ©pendances vulnÃ©rables
          if [ -f "package-lock.json" ]; then
            echo "ğŸ“¦ Scan des dÃ©pendances..."
            npm audit --audit-level=moderate || echo "âš ï¸  VulnÃ©rabilitÃ©s dÃ©tectÃ©es - vÃ©rifiez 'npm audit'"
          else
            echo "â„¹ï¸  package-lock.json non trouvÃ© - audit non effectuÃ©"
          fi
          
          # VÃ©rifier les permissions de fichiers
          echo ""
          echo "ğŸ” VÃ©rification des permissions..."
          find . -name "*.sh" -type f | while read file; do
            if [ -x "$file" ]; then
              echo "âš ï¸  Script exÃ©cutable dÃ©tectÃ©: $file"
            fi
          done

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-pipeline-build
          path: dist/
          retention-days: 7
        if: success()

      - name: Deploy preview (pour les PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸš€ DÃ©ploiement de prÃ©visualisation..."
          echo "=========================================="
          echo "URL de prÃ©visualisation disponible sur:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ“¦ Artefact tÃ©lÃ©chargeable dans l'onglet 'Artifacts'"

      - name: Deploy to dev (push sur dev)
        if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
        run: |
          echo "ğŸš€ DÃ©ploiement sur environnement dev..."
          echo "=========================================="
          echo "Cette Ã©tape dÃ©clencherait le dÃ©ploiement automatique"
          echo "sur le serveur de dÃ©veloppement."

      - name: Display CI Pipeline summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                CI PIPELINE SUMMARY               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Informations du pipeline:"
          echo "  ğŸ”„ Ã‰vÃ©nement: ${{ github.event_name }}"
          echo "  ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "  ğŸ‘¤ DÃ©clenchÃ© par: ${{ github.actor }}"
          echo "  ğŸ†” Execution ID: ${{ github.run_id }}"
          echo "  ğŸ“ Dossier source: ${{ env.SOURCE_DIR }}/"
          echo ""
          echo "ğŸ“‹ RÃ©sumÃ© des Ã©tapes:"
          echo "  âœ… Code checkout"
          echo "  âœ… Node.js 18 configurÃ©"
          echo "  âœ… DÃ©pendances installÃ©es"
          echo "  âœ… Validation structure projet"
          echo "  âœ… Validation HTML/structure"
          echo "  âœ… Validation assets"
          echo "  âœ… ExÃ©cution des tests"
          echo "  âœ… Build de l'application"
          echo "  ğŸ“¦ Artefact gÃ©nÃ©rÃ©: ci-pipeline-build"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ STATUS: SUCCÃˆS"
            echo ""
            echo "ğŸ“ˆ MÃ©triques:"
            echo "  - Build prÃªt pour dÃ©ploiement"
            echo "  - Artefact disponible pendant 7 jours"
            echo "  - QualitÃ© du code validÃ©e"
          else
            echo "âŒ STATUS: Ã‰CHEC"
            echo ""
            echo "ğŸ”§ Actions recommandÃ©es:"
            echo "  1. VÃ©rifier les logs d'erreur"
            echo "  2. Corriger les problÃ¨mes identifiÃ©s"
            echo "  3. Relancer le pipeline"
          fi
          
          echo ""
          echo "ğŸ”— Liens utiles:"
          echo "  ğŸ“‹ Logs complets: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  ğŸ“¦ Artefacts: Onglet 'Artifacts' dans GitHub Actions"
          echo ""