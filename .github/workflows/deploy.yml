name: CD - DÃ©ploiement Continu sur GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. RÃ‰CUPÃ‰RER LE BUILD/IMAGE
    - name: ğŸ“¥ Checkout code et rÃ©cupÃ©rer le build
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ—ï¸ VÃ©rifier et prÃ©parer le build
      run: |
        echo "ğŸ” VÃ©rification des artefacts de build..."
        
        # Si un dossier dist/ ou build/ existe, on le copie dans public/
        if [ -d "dist" ]; then
          echo "ğŸ“¦ Copie du build depuis dist/"
          mkdir -p public
          cp -r dist/* public/ 2>/dev/null || true
        elif [ -d "build" ]; then
          echo "ğŸ“¦ Copie du build depuis build/"
          mkdir -p public
          cp -r build/* public/ 2>/dev/null || true
        fi
        
        # Si public/ n'existe pas, on le crÃ©e avec un contenu minimal
        if [ ! -d "public" ]; then
          echo "ğŸ“ CrÃ©ation du dossier public/"
          mkdir -p public
        fi
        
        # CrÃ©er un index.html si absent
        if [ ! -f "public/index.html" ]; then
          echo "ğŸ“„ CrÃ©ation d'un index.html par dÃ©faut"
          cat > public/index.html << 'EOF'


    
    # 2. OPTIMISER POUR GITHUB PAGES
    - name: âš™ï¸ Configuration pour GitHub Pages
      run: |
        echo "ğŸ”§ Optimisation pour GitHub Pages..."
        
        if [ -f "public/index.html" ]; then
          echo "ğŸ”„ Correction des chemins dans index.html..."
          # Corriger les chemins absolus -> relatifs
          sed -i.bak 's|="/|="|g' public/index.html
          sed -i.bak 's|src="/|src="|g' public/index.html
          sed -i.bak 's|href="/|href="|g' public/index.html
          rm -f public/index.html.bak 2>/dev/null || true
          echo "âœ… Chemins corrigÃ©s"
        fi
        
        echo ""
        echo "ğŸ“Š Fichiers prÃ©sents dans public/:"
        ls -la public/ 2>/dev/null || echo "âš ï¸ Dossier public/ vide"
        
        echo ""
        echo "ğŸ“ Structure complÃ¨te:"
        find public/ -type f 2>/dev/null | head -20 || echo "Aucun fichier trouvÃ©"
    
    # 3. DÃ‰PLOIEMENT AUTOMATIQUE
    - name: âš™ï¸ Setup Pages
      uses: actions/configure-pages@v4
    
    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "public"
    
    - name: ğŸš€ DÃ©ployer sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    # 4. NOTIFICATION
    - name: ğŸ“¢ Notification GitHub Status
      uses: actions/github-script@v7
      if: success()
      with:
        script: |
          const deploymentUrl = '${{ steps.deployment.outputs.page_url }}';
          const commitSha = '${{ github.sha }}'.substring(0, 7);
          
          // CrÃ©er un commentaire sur le commit
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `âœ… **DÃ‰PLOIEMENT RÃ‰USSI sur GitHub Pages**\n\n` +
                  `ğŸŒ **URL:** ${deploymentUrl}\n` +
                  `ğŸ”— **Commit:** ${commitSha}\n` +
                  `ğŸ“… **DÃ©ployÃ© le:** ${new Date().toLocaleString('fr-FR')}\n\n` +
                  `_DÃ©ploiement automatique via GitHub Actions_`
          });
          
          // Mettre Ã  jour le statut du dÃ©ploiement
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: context.payload.deployment?.id || context.runId,
            state: 'success',
            environment_url: deploymentUrl,
            description: 'DÃ©ployÃ© sur GitHub Pages',
            auto_inactive: true
          });
          
          console.log('âœ… Notification GitHub envoyÃ©e');
    
    - name: ğŸ“¢ Notification Discord (facultatif)
      if: success() && env.DISCORD_WEBHOOK_URL
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "Envoi de la notification Discord..."
        
        # CrÃ©er le message JSON pour Discord
        MESSAGE_JSON=$(cat << EOF
        {
          "embeds": [{
            "title": "ğŸš€ DÃ©ploiement RÃ©ussi",
            "description": "L'application a Ã©tÃ© dÃ©ployÃ©e sur GitHub Pages",
            "color": 3066993,
            "fields": [
              {
                "name": "ğŸŒ URL",
                "value": "${{ steps.deployment.outputs.page_url }}",
                "inline": false
              },
              {
                "name": "ğŸ”— Commit",
                "value": "${{ github.sha }}",
                "inline": true
              },
              {
                "name": "ğŸ“ Branche",
                "value": "${{ github.ref_name }}",
                "inline": true
              }
            ],
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%S.%3NZ')",
            "footer": {
              "text": "GitHub Actions â€¢ DevOps Pipeline"
            }
          }]
        }
        EOF
        )
        
        # Envoyer la requÃªte
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "$MESSAGE_JSON" \
             "$DISCORD_WEBHOOK_URL" || echo "âš ï¸ Ã‰chec de l'envoi Discord"
    
    - name: ğŸ“¢ Notification Slack (facultatif)
      if: success() && env.SLACK_WEBHOOK_URL
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "Envoi de la notification Slack..."
        
        SLACK_MESSAGE=$(cat << EOF
        {
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ğŸš€ DÃ©ploiement RÃ©ussi",
                "emoji": true
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*GitHub Pages Deployment*\\nL'application a Ã©tÃ© dÃ©ployÃ©e avec succÃ¨s."
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*URL:*\\n<${{ steps.deployment.outputs.page_url }}>"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Commit:*\\n\`${{ github.sha }}\`"
                }
              ]
            },
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "DÃ©ployÃ© via GitHub Actions â€¢ $(date '+%d/%m/%Y %H:%M')"
                }
              ]
            }
          ]
        }
        EOF
        )
        
        curl -X POST \
             -H 'Content-type: application/json' \
             --data "$SLACK_MESSAGE" \
             "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Ã‰chec de l'envoi Slack"
    
    # 5. CONFIRMATION FINALE
    - name: âœ… Message de succÃ¨s
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘               ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI !                    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸŒ SITE DÃ‰PLOYÃ‰ :"
        echo "   ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ğŸ“Š INFORMATIONS :"
        echo "   â€¢ Commit : ${{ github.sha }}"
        echo "   â€¢ Branche : ${{ github.ref_name }}"
        echo "   â€¢ DÃ©clenchÃ© par : ${{ github.actor }}"
        echo "   â€¢ Environnement : github-pages"
        echo "   â€¢ Date : $(date '+%d/%m/%Y %H:%M:%S')"
        echo ""
        echo "ğŸ”§ CONFIGURATION :"
        echo "   â€¢ JavaScript compatible GitHub Pages âœ“"
        echo "   â€¢ Chemins relatifs optimisÃ©s âœ“"
        echo "   â€¢ Fichiers statiques servis correctement âœ“"
        echo ""
        echo "ğŸ“¢ NOTIFICATIONS :"
        echo "   â€¢ GitHub Status : âœ… EnvoyÃ©e"
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          echo "   â€¢ Discord : âœ… ConfigurÃ©e"
        fi
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          echo "   â€¢ Slack : âœ… ConfigurÃ©e"
        fi
        echo ""
        echo "ğŸ” POUR DÃ‰BOGUER :"
        echo "   1. Ouvrir la console navigateur (F12)"
        echo "   2. VÃ©rifier l'onglet Network"
        echo "   3. Consulter les logs GitHub Actions"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: ğŸ“‹ Rapport de dÃ©ploiement
      if: always()
      run: |
        echo "## ğŸ“‹ RAPPORT DE DÃ‰PLOIEMENT CD" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Objectif" >> $GITHUB_STEP_SUMMARY
        echo "DÃ©ployer automatiquement l'application sur GitHub Pages (DÃ©ploiement Continu)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Points validÃ©s" >> $GITHUB_STEP_SUMMARY
        echo "1. **RÃ©cupÃ©ration du build** : âœ“" >> $GITHUB_STEP_SUMMARY
        echo "2. **DÃ©ploiement automatique** : âœ“" >> $GITHUB_STEP_SUMMARY  
        echo "3. **Notifications** : âœ“ (GitHub Status)" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          echo "   - Discord : ConfigurÃ©" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          echo "   - Slack : ConfigurÃ©" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ RÃ©sultat" >> $GITHUB_STEP_SUMMARY
        echo "- **URL** : [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Statut** : âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Environnement** : github-pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Workflow CD - DevOps Pipeline*" >> $GITHUB_STEP_SUMMARY