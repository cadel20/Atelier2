name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Ensure JS works on GitHub Pages
      run: |
        echo "ðŸ”§ Configuration pour GitHub Pages..."
        if [ -f "public/index.html" ]; then
          echo "Fixing paths in index.html..."
          sed -i.bak 's|="/|="|g' public/index.html
        fi
        echo ""
        echo "ðŸ“Š Fichiers prÃ©sents:"
        ls -la public/ 2>/dev/null || echo "Dossier public/ vide"
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "public"
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    # NOTIFICATION DISCORD - AMÃ‰LIORÃ‰E
    - name: Send Discord notification
      if: success()
      run: |
        # VÃ©rifier si le secret existe
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          echo "ðŸ“¢ Envoi de la notification Discord..."
          
          # Message Discord avec embed (plus joli)
          DISCORD_MSG=$(cat << EOF
          {
            "embeds": [{
              "title": "ðŸš€ DÃ©ploiement GitHub Pages RÃ©ussi",
              "description": "Le pipeline CI/CD a dÃ©ployÃ© avec succÃ¨s l'application sur GitHub Pages",
              "color": 5763719,
              "fields": [
                {
                  "name": "ðŸŒ URL",
                  "value": "${{ steps.deployment.outputs.page_url }}",
                  "inline": false
                },
                {
                  "name": "ðŸ”— Commit",
                  "value": "${{ github.sha }}",
                  "inline": true
                },
                {
                  "name": "ðŸ“ Branche",
                  "value": "${{ github.ref_name }}",
                  "inline": true
                }
              ],
              "footer": {
                "text": "GitHub Actions â€¢ DevOps Pipeline"
              },
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%S.%3NZ')"
            }]
          }
          EOF
          )
          
          # Envoyer la requÃªte
          curl -s -X POST \
               -H "Content-Type: application/json" \
               -d "$DISCORD_MSG" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
          
          echo "âœ… Notification Discord envoyÃ©e"
        else
          echo "â„¹ï¸ Secret DISCORD_WEBHOOK_URL non configurÃ© - Notification Discord ignorÃ©e"
          echo "Pour activer les notifications Discord:"
          echo "1. CrÃ©ez un webhook dans Discord"
          echo "2. Ajoutez DISCORD_WEBHOOK_URL dans les secrets GitHub"
        fi
    
    - name: Success message
      run: |
        echo ""
        echo "ðŸŽ‰ DÃ‰PLOIEMENT RÃ‰USSI !"
        echo ""
        echo "ðŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ðŸ“Š DÃ©tails:"
        echo "- Commit: ${{ github.sha }}"
        echo "- Branche: ${{ github.ref_name }}"
        echo "- DÃ©clenchÃ© par: ${{ github.actor }}"
        echo "- Date: $(date)"
        echo ""
        echo "âœ… Tous les points CD validÃ©s:"
        echo "1. âœ“ Build rÃ©cupÃ©rÃ©"
        echo "2. âœ“ DÃ©ploiement automatique"
        echo "3. âœ“ Notification envoyÃ©e"