name: CI Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Validate & Build
    env:
      NODE_ENV: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --no-audit --prefer-offline
        env:
          NODE_ENV: development

      - name: Validate HTML structure
        run: |
          echo "üîç Validation de la structure HTML..."
          echo "=========================================="
          
          # V√©rifier l'existence des fichiers essentiels
          REQUIRED_FILES=("index.html" "package.json")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå ERREUR CRITIQUE: $file manquant"
              exit 1
            fi
            echo "‚úÖ $file pr√©sent"
          done
          
          # Validation approfondie d'index.html
          echo ""
          echo "üìã Validation d'index.html..."
          
          # V√©rifier le doctype (CRITIQUE)
          if ! grep -q "^<!DOCTYPE html>" index.html; then
            echo "‚ùå ERREUR CRITIQUE: Doctype HTML5 manquant"
            exit 1
          fi
          echo "‚úÖ Doctype HTML5 pr√©sent"
          
          # V√©rifier les balises essentielles
          ESSENTIAL_TAGS=("html lang=" "head" "body" "title" "meta charset=" "meta name=\"viewport\"")
          missing_tags=0
          
          for tag in "${ESSENTIAL_TAGS[@]}"; do
            if ! grep -q "$tag" index.html; then
              echo "‚ö†Ô∏è  ATTENTION: '$tag' manquant ou incorrect"
              ((missing_tags++))
            else
              echo "‚úÖ '$tag' pr√©sent"
            fi
          done
          
          # V√©rifier les balises de fermeture
          echo ""
          echo "üîí V√©rification des balises fermantes..."
          if ! grep -q "</html>" index.html; then
            echo "‚ö†Ô∏è  ATTENTION: Balise </html> manquante"
            ((missing_tags++))
          fi
          if ! grep -q "</body>" index.html; then
            echo "‚ö†Ô∏è  ATTENTION: Balise </body> manquante"
            ((missing_tags++))
          fi
          
          # V√©rifier la taille du fichier
          echo ""
          echo "üìè Analyse de la taille..."
          FILE_SIZE=$(stat -f%z index.html 2>/dev/null || stat -c%s index.html 2>/dev/null)
          echo "Taille d'index.html: $FILE_SIZE octets"
          
          if [ $FILE_SIZE -lt 1000 ]; then
            echo "‚ö†Ô∏è  ATTENTION: Fichier tr√®s petit (<1KB) - possible erreur"
          elif [ $FILE_SIZE -gt 500000 ]; then
            echo "‚ö†Ô∏è  ATTENTION: Fichier tr√®s grand (>500KB) - optimisation recommand√©e"
          else
            echo "‚úÖ Taille optimale"
          fi
          
          # V√©rifier les ressources externes
          echo ""
          echo "üåê V√©rification des ressources..."
          if grep -q "http://" index.html; then
            echo "‚ö†Ô∏è  ATTENTION: Liens HTTP non s√©curis√©s d√©tect√©s (pr√©f√©rez HTTPS)"
          fi
          
          # V√©rifier les scripts et styles
          SCRIPT_COUNT=$(grep -c "<script" index.html)
          STYLE_COUNT=$(grep -c "<style\|\.css" index.html)
          echo "Scripts d√©tect√©s: $SCRIPT_COUNT"
          echo "Styles d√©tect√©s: $STYLE_COUNT"
          
          # R√©sum√©
          echo ""
          echo "=========================================="
          if [ $missing_tags -gt 0 ]; then
            echo "‚ö†Ô∏è  Validation termin√©e avec $missing_tags avertissement(s)"
          else
            echo "‚úÖ Validation HTML r√©ussie"
          fi

      - name: Check package.json structure
        run: |
          echo "üì¶ Validation de package.json..."
          echo "=========================================="
          
          # V√©rifier les champs essentiels
          REQUIRED_FIELDS=("name" "version" "description")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! grep -q "\"$field\"" package.json; then
              echo "‚ö†Ô∏è  ATTENTION: Champ '$field' manquant dans package.json"
            else
              echo "‚úÖ '$field' pr√©sent"
            fi
          done
          
          # V√©rifier les scripts
          echo ""
          echo "‚ö° Scripts disponibles:"
          if grep -q '"scripts"' package.json; then
            npm run
          else
            echo "‚ÑπÔ∏è  Aucun script d√©fini"
          fi

      - name: Run linter (si configur√©)
        run: |
          echo "üßπ Ex√©cution du linter..."
          if [ -f ".eslintrc" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            echo "ESLint configur√© - ex√©cution..."
            npx eslint . --ext .js || echo "‚ö†Ô∏è  ESLint a trouv√© des probl√®mes"
          else
            echo "‚ÑπÔ∏è  ESLint non configur√©"
          fi

      - name: Run tests
        run: |
          echo "üß™ Ex√©cution des tests..."
          echo "=========================================="
          
          # V√©rifier si des tests sont configur√©s
          if npm run | grep -q " test "; then
            echo "Tests d√©tect√©s - ex√©cution..."
            npm test
            TEST_RESULT=$?
            
            if [ $TEST_RESULT -eq 0 ]; then
              echo "‚úÖ Tous les tests ont r√©ussi"
            else
              echo "‚ùå Certains tests ont √©chou√©"
              exit $TEST_RESULT
            fi
          else
            echo "‚ÑπÔ∏è  Aucun script de test trouv√©"
            echo "‚úÖ Tests simul√©s - status OK"
          fi

      - name: Build application
        run: |
          echo "üèóÔ∏è  Construction de l'application..."
          echo "=========================================="
          
          # Cr√©er le dossier de build
          BUILD_DIR="dist"
          echo "Cr√©ation du dossier: $BUILD_DIR"
          mkdir -p $BUILD_DIR
          
          # Copier les fichiers essentiels
          echo "üìÅ Copie des fichiers..."
          
          # HTML
          cp index.html $BUILD_DIR/
          echo "‚úÖ index.html copi√©"
          
          # CSS
          if [ -d "css" ]; then
            cp -r css $BUILD_DIR/
            echo "‚úÖ Dossier css copi√©"
          fi
          
          # JS
          if [ -d "js" ]; then
            cp -r js $BUILD_DIR/
            echo "‚úÖ Dossier js copi√©"
          fi
          
          # Images
          if [ -d "images" ]; then
            cp -r images $BUILD_DIR/
            echo "‚úÖ Dossier images copi√©"
          fi
          
          # Autres fichiers statiques
          for pattern in "*.css" "*.js" "*.png" "*.jpg" "*.jpeg" "*.gif" "*.ico" "*.svg" "*.woff" "*.woff2" "*.ttf" "*.json"; do
            for file in $pattern; do
              if [ -f "$file" ] && [ "$file" != "package.json" ]; then
                cp "$file" $BUILD_DIR/
                echo "üìÑ $file copi√©"
              fi
            done
          done
          
          # Afficher la structure du build
          echo ""
          echo "üìÇ Structure du dossier $BUILD_DIR:"
          find $BUILD_DIR -type f | sort | sed 's/^/  /'
          echo ""
          echo "üìä Taille totale: $(du -sh $BUILD_DIR | cut -f1)"

      - name: Security scan
        run: |
          echo "üîí Scan de s√©curit√©..."
          echo "=========================================="
          
          # V√©rifier les d√©pendances vuln√©rables
          if [ -f "package-lock.json" ]; then
            echo "üì¶ Scan des d√©pendances..."
            npm audit --audit-level=moderate || echo "‚ö†Ô∏è  Vuln√©rabilit√©s d√©tect√©es - v√©rifiez 'npm audit'"
          else
            echo "‚ÑπÔ∏è  package-lock.json non trouv√© - audit non effectu√©"
          fi
          
          # V√©rifier les permissions de fichiers
          echo ""
          echo "üîê V√©rification des permissions..."
          find . -name "*.sh" -type f | while read file; do
            if [ -x "$file" ]; then
              echo "‚ö†Ô∏è  Script ex√©cutable d√©tect√©: $file"
            fi
          done

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-pipeline-build
          path: dist/
          retention-days: 7
        if: success()

      - name: Deploy preview (pour les PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "üöÄ D√©ploiement de pr√©visualisation..."
          echo "=========================================="
          echo "URL de pr√©visualisation disponible sur:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "üì¶ Artefact t√©l√©chargeable dans l'onglet 'Artifacts'"

      - name: Deploy to dev (push sur dev)
        if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
        run: |
          echo "üöÄ D√©ploiement sur environnement dev..."
          echo "=========================================="
          echo "Cette √©tape d√©clencherait le d√©ploiement automatique"
          echo "sur le serveur de d√©veloppement."

      - name: Display CI Pipeline summary
        if: always()
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë                CI PIPELINE SUMMARY               ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üìä Informations du pipeline:"
          echo "  üîÑ √âv√©nement: ${{ github.event_name }}"
          echo "  üåø Branche: ${{ github.ref_name }}"
          echo "  üë§ D√©clench√© par: ${{ github.actor }}"
          echo "  üÜî Execution ID: ${{ github.run_id }}"
          echo ""
          echo "üìã R√©sum√© des √©tapes:"
          echo "  ‚úÖ Code checkout"
          echo "  ‚úÖ Node.js 18 configur√©"
          echo "  ‚úÖ D√©pendances install√©es"
          echo "  ‚úÖ Validation HTML/structure"
          echo "  ‚úÖ Ex√©cution des tests"
          echo "  ‚úÖ Build de l'application"
          echo "  üì¶ Artefact g√©n√©r√©: ci-pipeline-build"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ STATUS: SUCC√àS"
            echo ""
            echo "üìà M√©triques:"
            echo "  - Build pr√™t pour d√©ploiement"
            echo "  - Artefact disponible pendant 7 jours"
            echo "  - Qualit√© du code valid√©e"
          else
            echo "‚ùå STATUS: √âCHEC"
            echo ""
            echo "üîß Actions recommand√©es:"
            echo "  1. V√©rifier les logs d'erreur"
            echo "  2. Corriger les probl√®mes identifi√©s"
            echo "  3. Relancer le pipeline"
          fi
          
          echo ""
          echo "üîó Liens utiles:"
          echo "  üìã Logs complets: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  üì¶ Artefacts: Onglet 'Artifacts' dans GitHub Actions"
          echo ""